<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ± ì—°ë™í˜• í•™ìŠµ ì§„ì²™ë„ ëŒ€ì‹œë³´ë“œ (Firestore)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /*
         * ----------------------------------------------------
         * 1. Pretendard í°íŠ¸ (CDN Fallback)
         * ----------------------------------------------------
         */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css');

        /*
         * ----------------------------------------------------
         * 2. CSS ìŠ¤íƒ€ì¼ ë° ì‚¬ìš©ì ìš”ì²­ í…Œë§ˆ (Green & Beige)
         * ----------------------------------------------------
         */
        :root {
            --font-family: 'Pretendard', sans-serif;
            --primary-text: #242424;
            --secondary-text: #888;
            --background: #F0F5EF; /* ì‚¬ìš©ì ìš”ì²­: ì—°í•œ ë² ì´ì§€/ê·¸ë¦° */
            --card-background: #ffffff;
            --border-color: #D4E0D2; /* ìƒˆë¡œìš´ ìƒ‰ìƒ ê¸°ë°˜ì˜ ì—°í•œ ê²½ê³„ì„  */
            --accent-main: #A1BA9A; /* ì‚¬ìš©ì ìš”ì²­: ì£¼ ê°•ì¡°ìƒ‰ (ì§„í•œ ê·¸ë¦°) */
            --accent-light: #D4E0D2; /* ë³´ì¡° ê°•ì¡°ìƒ‰ (ì—°í•œ ê·¸ë¦°) */
            --shadow-light: 0 2px 5px rgba(0, 0, 0, 0.08);
            --timeline-bg: #E8EDE7;
            --progress-color: var(--accent-main);
            --book-color: var(--accent-main);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .dashboard-container {
            width: 100%;
            max-width: 1200px;
            padding: 0 20px 30px; /* ìƒë‹¨ ë°°ë„ˆë¥¼ ìœ„í•´ ìƒë‹¨ íŒ¨ë”© ì œê±° */
        }

        /* ------------------- ìƒë‹¨ ë°°ë„ˆ (ì´ë¯¸ì§€) ìŠ¤íƒ€ì¼ ------------------- */
        #top-banner {
            width: 100%;
            height: 200px; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì • ê°€ëŠ¥ */
            background-image: url('uploaded: -5.jpg-2031be08-6a02-4ba6-98a0-8fd3a3172b8c'); /* ì‚¬ìš©ì ìš”ì²­ ì´ë¯¸ì§€ */
            background-size: cover;
            background-position: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            margin: 30px 0 15px 0;
            color: var(--primary-text);
        }
        .section-title i { margin-right: 10px; color: var(--accent-main); }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 20px 0;
        }
        .page-title { font-size: 2.5em; font-weight: 700; }

        #user-info {
            font-size: 0.8em;
            color: var(--secondary-text);
            text-align: right;
            margin-top: 5px;
        }
        #dday-popover-trigger {
            padding: 8px 15px;
            background-color: var(--accent-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--primary-text);
            transition: background 0.2s;
        }
        #dday-popover-trigger:hover { background-color: var(--accent-main); color: white; }

        .main-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* ------------------- ì‹œê³„ ë””ìì¸ (IMG_3101.PNG ë°˜ì˜) ------------------- */
        #study-timer-card {
            text-align: center;
        }
        #study-timer-display {
            font-size: 3.5em; /* í¬ê¸° í™•ëŒ€ */
            font-weight: 800; /* êµµê²Œ */
            color: var(--accent-main); /* ê°•ì¡°ìƒ‰ */
            margin: 10px 0 20px 0;
            font-family: 'Consolas', 'Courier New', monospace; /* ë””ì§€í„¸ ëŠë‚Œ í°íŠ¸ */
        }

        /* ------------------- ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ ------------------- */
        #calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .day-header { padding: 10px 0; font-weight: 700; color: var(--secondary-text); }
        .day-cell {
            padding: 10px 5px;
            height: 50px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 0.9em;
            position: relative;
        }
        .day-cell:hover, .day-cell.selected { background-color: var(--accent-light); }
        .day-cell.today { border: 2px solid var(--accent-main); }
        .day-cell.other-month { color: #ccc; }
        .day-cell .todo-marker {
            position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: var(--book-color); border-radius: 50%;
        }

        /* ------------------- ëª¨ë‹¬ (íŒì—…ì°½ ë””ìì¸ - IMG_3102.jpg ë°˜ì˜) ------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            /* íŒì—…ì°½ ë””ìì¸ */
            background-color: var(--card-background);
            margin: 5% auto;
            border-top: 25px solid #E0E0E0; /* íŒì—…ì°½ ìƒë‹¨ ë°” ëŠë‚Œ */
            border-radius: 5px;
            width: 80%;
            max-width: 450px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-content::before { /* íŒì—…ì°½ ì œëª© í‘œì‹œì¤„ í…ìŠ¤íŠ¸ */
            content: "ë””ë°ì´ ì„¤ì •";
            position: absolute;
            top: -20px;
            left: 5px;
            color: var(--primary-text);
            font-size: 0.9em;
            font-weight: 600;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute; /* íŒì—…ì°½ ìƒë‹¨ì— X ë²„íŠ¼ ë°°ì¹˜ */
            top: -25px;
            right: 5px;
            line-height: 25px;
        }
        .close-btn:hover { color: #000; }

        /* ------------------- ë²„íŠ¼ ìŠ¤íƒ€ì¼ ------------------- */
        button {
            background-color: var(--accent-main);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-family: var(--font-family);
        }
        button:hover { background-color: #7A9B79; } /* hover ìƒ‰ìƒ ì¡°ì • */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }

        /* --- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ (íƒ€ì„ë¼ì¸, ëª©í‘œ í…Œì´ë¸”, ë¶ ì¹´ë“œ ë“±) --- */
        #timeline-chart {
            background-color: var(--timeline-bg);
            border-radius: 8px;
            padding: 15px;
            height: 100%;
            min-height: 600px;
            position: relative;
        }
        .timeline-hour {
            font-size: 0.75em;
            color: var(--secondary-text);
            position: absolute;
            left: 5px;
            width: 95%;
            border-top: 1px dashed #ddd;
            padding-left: 35px;
        }
        .timeline-block {
            position: absolute;
            left: 45px;
            width: calc(100% - 50px);
            background-color: var(--accent-light);
            border-radius: 4px;
            opacity: 0.85;
            padding: 2px 5px;
            font-size: 0.8em;
            color: var(--primary-text);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .notion-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .notion-table th, .notion-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        .notion-table th {
            background-color: var(--accent-light);
            font-weight: 700;
        }
        .notion-table .progress-bar {
            height: 100%;
            background: var(--progress-color);
            transition: width 0.3s;
        }
        .notion-table .delete-btn {
            background: none;
            border: none;
            color: #ff5252;
            cursor: pointer;
            font-size: 1.1em;
        }
        .book-card {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        /* ------------------- ë°˜ì‘í˜• ë””ìì¸ ------------------- */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .calendar-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">

        <div id="top-banner"></div>

        <header>
            <div>
                <h1 class="page-title">âœï¸ Study Dashboard</h1>
                <div id="user-info"></div>
            </div>
            <div id="dday-popover-trigger" onclick="toggleDDayModal()">D-Day</div>
        </header>

        <div id="dday-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="toggleDDayModal()">&times;</span>
                <h2>ì‹œí—˜ ëª©í‘œì¼ ì„¤ì •</h2>
                <p id="dday-result" style="font-size: 1.5em; font-weight: 700; color: var(--primary-text); margin-bottom: 20px;">D-Day ê³„ì‚° ì¤‘...</p>
                <label for="dday-input">ëª©í‘œ ë‚ ì§œ:</label>
                <input type="date" id="dday-input" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px;">
                <button onclick="saveDDay()" style="margin-top: 15px; width: 100%;">ë””ë°ì´ ì €ì¥</button>
            </div>
        </div>

        <div class="main-grid">
            <div>
                <div class="calendar-grid">
                    <div id="calendar-card" class="card">
                        <h2 class="section-title"><i class="fas fa-calendar-alt"></i> í•™ìŠµ ë‹¬ë ¥</h2>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <button onclick="changeMonth(-1)">&#9664;</button>
                            <h3 id="month-year-display" style="margin: 0;"></h3>
                            <button onclick="changeMonth(1)">&#9654;</button>
                        </div>
                        <div id="calendar-view">
                            </div>
                    </div>
                    <div id="daily-todo-card" class="card">
                        <h2 class="section-title"><i class="fas fa-tasks"></i> <span id="selected-date-display">ì˜¤ëŠ˜</span>ì˜ í•  ì¼</h2>
                        <div id="todos-list">
                            <p style="color:var(--secondary-text);">ë‚ ì§œë¥¼ ì„ íƒí•˜ê±°ë‚˜, ì˜¤ëŠ˜ì˜ í•  ì¼ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>
                        </div>

                        <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin-top: 0;">í•  ì¼ ì¶”ê°€</h4>
                            <select id="todo-book-select" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"></select>
                            <input type="number" id="todo-start-page" placeholder="ì‹œì‘ í˜ì´ì§€" style="width: calc(50% - 5px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px;">
                            <input type="number" id="todo-end-page" placeholder="ë í˜ì´ì§€" style="width: calc(50% - 5px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-left: 5px;">
                            <textarea id="todo-note" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ (ì„ íƒ)" style="width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            <button onclick="addDailyTodo()" style="width: 100%;">í•  ì¼ ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title"><i class="fas fa-bullseye"></i> ì›”ê°„ & ì£¼ê°„ ëª©í‘œ</h2>
                    <h3 style="margin-top: 0;">ì›”ê°„ ëª©í‘œ</h3>
                    <div id="monthly-goal-table-container">
                        <table id="monthly-goal-table" class="notion-table">
                            <thead>
                                <tr><th>ëª©í‘œ</th><th>ê¸°ê°„</th><th>ì§„ì²™ë„</th><th>ë©”ëª¨</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button onclick="addRow('monthly')" style="margin-top: 10px;">+ ëª©í‘œ ì¶”ê°€</button>
                    </div>

                    <h3 style="margin-top: 20px;">ì£¼ê°„ ëª©í‘œ</h3>
                    <div id="weekly-goal-table-container">
                        <table id="weekly-goal-table" class="notion-table">
                            <thead>
                                <tr><th>ëª©í‘œ</th><th>ê¸°ê°„</th><th>ì§„ì²™ë„</th><th>ë©”ëª¨</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button onclick="addRow('weekly')" style="margin-top: 10px;">+ ëª©í‘œ ì¶”ê°€</button>
                    </div>
                </div>
            </div>

            <div>
                <div id="study-timer-card" class="card" style="text-align: center; background-color: var(--accent-light);">
                    <h2 class="section-title" style="margin-top: 0;"><i class="fas fa-stopwatch"></i> Now Studying</h2>
                    <div id="study-timer-display">00:00:00</div>
                    <div class="btn-group" style="justify-content: center;">
                        <button id="start-btn" onclick="startTimer()">ì‹œì‘</button>
                        <button id="pause-btn" onclick="pauseTimer()" disabled>ì¼ì‹œì •ì§€</button>
                        <button id="reset-btn" onclick="resetTimer()">ì´ˆê¸°í™”</button>
                    </div>
                    <p style="font-size: 0.9em; color: var(--secondary-text); margin-top: 10px;">* íƒ€ì´ë¨¸ ê¸°ë¡ì€ íƒ€ì„ë¼ì¸ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                </div>

                <div class="card">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> ì˜¤ëŠ˜ì˜ í•™ìŠµ íƒ€ì„ë¼ì¸</h2>
                    <div id="timeline-chart">
                        <div class="timeline-hour" style="top: 0%;">00:00</div>
                        <div class="timeline-hour" style="top: 12.5%;">03:00</div>
                        <div class="timeline-hour" style="top: 25%;">06:00</div>
                        <div class="timeline-hour" style="top: 37.5%;">09:00</div>
                        <div class="timeline-hour" style="top: 50%;">12:00</div>
                        <div class="timeline-hour" style="top: 62.5%;">15:00</div>
                        <div class="timeline-hour" style="top: 75%;">18:00</div>
                        <div class="timeline-hour" style="top: 87.5%;">21:00</div>
                        <div class="timeline-hour" style="top: 100%; border: none;">24:00</div>
                        </div>
                </div>

                <div class="card">
                    <h2 class="section-title"><i class="fas fa-book-open"></i> ë¬¸ì œì§‘ ë³´ê´€í•¨ (Book Shelf)</h2>
                    <button onclick="openBookModal()">+ ìƒˆ ë¬¸ì œì§‘ ë“±ë¡</button>
                    <div id="book-shelf-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <p style="color:var(--secondary-text); grid-column: 1 / -1;">ë“±ë¡ëœ ë¬¸ì œì§‘ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="book-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeBookModal()">&times;</span>
            <h2>ë¬¸ì œì§‘ ë“±ë¡/ìˆ˜ì •</h2>
            <input type="hidden" id="book-edit-id">
            <label for="book-title">ì œëª©:</label>
            <input type="text" id="book-title" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px;">

            <label for="book-pages">ì´ í˜ì´ì§€:</label>
            <input type="number" id="book-pages" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px;">

            <label for="book-target-pages">ëª©í‘œ í˜ì´ì§€ (ì „ì²´ ì¤‘ ëª©í‘œ):</label>
            <input type="number" id="book-target-pages" placeholder="ì§„ì²™ë„ ê³„ì‚° ê¸°ì¤€" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px;">

            <label for="book-image">í‘œì§€ ì´ë¯¸ì§€ URL (ì„ íƒ):</label>
            <input type="text" id="book-image" placeholder="https://..." style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px;">

            <label for="book-index">ëª©ì°¨ (ì„ íƒ, ë‚˜ì¤‘ì— ì‚¬ìš©):</label>
            <textarea id="book-index" placeholder="1ë‹¨ì›: 10-30p, 2ë‹¨ì›: 31-50p" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px; height: 80px;"></textarea>

            <button onclick="saveBook()">ì €ì¥</button>
        </div>
    </div>


    <script>
        // í˜„ì¬ ë‚ ì§œë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ë‹¬ë ¥ìš©)
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let selectedDate = new Date(); // ìƒì„¸ í•  ì¼ì„ ë³´ì—¬ì¤„ ë‚ ì§œ
        
        // ë°ì´í„° ì €ì¥ì†Œ (Firestore ì—°ë™ ì „ ì„ì‹œ ë°ì´í„° ë˜ëŠ” UI ë Œë”ë§ìš©)
        let monthlyGoalsData = [];
        let weeklyGoalsData = [];
        let booksData = [];
        let dailyTodosData = {}; // key: 'YYYY-MM-DD', value: [todo objects]
        let studyTimelineData = {}; // key: 'YYYY-MM-DD', value: [time block objects]
        let userId = 'default_user';
        let isAuthReady = false;

        // --- D-Day ë° íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜ ---
        let dDayTargetDate = localStorage.getItem('dDayTargetDate');
        let timerInterval = null;
        let studySeconds = 0;
        let isTimerRunning = false;
        
        /*
         * ----------------------------------------------------
         * 1. Firebase ì„¤ì • (â˜…â˜…â˜… ì‚¬ìš©ìë‹˜ì˜ ì •ë³´ë¡œ ë³€ê²½ í•„ìˆ˜! â˜…â˜…â˜…)
         * ----------------------------------------------------
         */
        const firebaseConfig = {
            // ì—¬ê¸°ì— ì‚¬ìš©ìë‹˜ì˜ Firebase ì„¤ì • ì •ë³´(apiKey, authDomain ë“±)ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
            // ì˜ˆì‹œ:
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            // projectId: "YOUR_PROJECT_ID",
            // ...
        };

        if (firebaseConfig.apiKey) {
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            auth.onAuthStateChanged(user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.email}ë‹˜`;
                    isAuthReady = true;
                    initDataListeners(); // ì¸ì¦ë˜ë©´ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                } else {
                    // ìµëª… ë¡œê·¸ì¸ìœ¼ë¡œ ì‹œì‘ (í…ŒìŠ¤íŠ¸ ë° ë‹¨ì¼ ì‚¬ìš©ì í™˜ê²½ì— ìœ ìš©)
                    auth.signInAnonymously().catch((error) => {
                        console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                        document.getElementById('user-info').textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨ (Firestore ë¹„í™œì„±)";
                    });
                }
            });

            // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œë¥¼ ì‰½ê²Œ ì–»ê¸° ìœ„í•œ í•¨ìˆ˜
            function getUserCollection(collection) {
                return db.collection('users').doc(userId).collection(collection);
            }

            // ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            function initDataListeners() {
                // ëª©í‘œ ë°ì´í„° (ì›”ê°„/ì£¼ê°„)
                ['monthly', 'weekly'].forEach(key => {
                    db.collection('users').doc(userId).collection(getGoalCollectionName(key))
                        .onSnapshot((snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (key === 'monthly') {
                                monthlyGoalsData = data;
                            } else {
                                weeklyGoalsData = data;
                            }
                            updateProgressAll(); // ëª©í‘œ ë°ì´í„° ë³€ê²½ ì‹œ ì „ì²´ UI ì—…ë°ì´íŠ¸
                        }, (error) => console.error(`Error listening to ${key} goals:`, error));
                });

                // ë¬¸ì œì§‘ ë°ì´í„°
                db.collection('users').doc(userId).collection('books')
                    .onSnapshot((snapshot) => {
                        booksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderBookShelf();
                        renderTodoBookSelect(document.getElementById('todo-book-select'));
                        renderTodoBookSelect(document.getElementById('book-select-modal')); // ëª¨ë‹¬ìš©
                        updateProgressAll();
                    }, (error) => console.error("Error listening to books:", error));

                // ì¼ì¼ í•  ì¼ ë°ì´í„°
                db.collection('users').doc(userId).collection('dailyTodos')
                    .onSnapshot((snapshot) => {
                        const data = {};
                        snapshot.docs.forEach(doc => {
                            const dateStr = doc.id; // ë¬¸ì„œ IDë¥¼ ë‚ ì§œ ë¬¸ìì—´ë¡œ ì‚¬ìš© (YYYY-MM-DD)
                            data[dateStr] = doc.data().todos || [];
                        });
                        dailyTodosData = data;
                        renderCalendar(currentYear, currentMonth); // ë‹¬ë ¥ ë§ˆì»¤ ì—…ë°ì´íŠ¸
                        loadDailyTodosUI(formatDate(selectedDate)); // í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ í•  ì¼ ì—…ë°ì´íŠ¸
                        updateProgressAll(); // ì§„ì²™ë„ ì—…ë°ì´íŠ¸
                    }, (error) => console.error("Error listening to daily todos:", error));

                // íƒ€ì„ë¼ì¸ ë°ì´í„°
                db.collection('users').doc(userId).collection('studyTimeline')
                    .onSnapshot((snapshot) => {
                        const data = {};
                        snapshot.docs.forEach(doc => {
                            const dateStr = doc.id;
                            data[dateStr] = doc.data().blocks || [];
                        });
                        studyTimelineData = data;
                        renderTimeline(formatDate(selectedDate)); // í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
                    }, (error) => console.error("Error listening to study timeline:", error));
            }

        } else {
            document.getElementById('user-info').textContent = "âš ï¸ Firebase ì„¤ì • í•„ìš”";
        }


        /*
         * ----------------------------------------------------
         * 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
         * ----------------------------------------------------
         */

        function getGoalCollectionName(key) {
            return key === 'monthly' ? 'monthlyGoals' : 'weeklyGoals';
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function parseDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function calculateDDay(targetDateStr) {
            if (!targetDateStr) return 'D-Day ì„¤ì • í•„ìš”';
            const target = parseDate(targetDateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // ì‹œê°„ ì´ˆê¸°í™”

            const diffTime = target.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'D-Day';
            if (diffDays > 0) return `D-${diffDays}`;
            return `D+${Math.abs(diffDays)}`;
        }

        /*
         * ----------------------------------------------------
         * 3. D-Day / íƒ€ì´ë¨¸ ê¸°ëŠ¥
         * ----------------------------------------------------
         */
        function toggleDDayModal() {
            const modal = document.getElementById('dday-modal');
            const input = document.getElementById('dday-input');
            const result = document.getElementById('dday-result');

            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
                input.value = dDayTargetDate || '';
                result.textContent = calculateDDay(dDayTargetDate);
            }
        }

        function saveDDay() {
            const input = document.getElementById('dday-input').value;
            dDayTargetDate = input;
            localStorage.setItem('dDayTargetDate', dDayTargetDate);
            document.getElementById('dday-popover-trigger').textContent = calculateDDay(dDayTargetDate);
            toggleDDayModal();
        }

        // ì´ˆê¸° D-Day ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dday-popover-trigger').textContent = calculateDDay(dDayTargetDate);
        });

        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('reset-btn').disabled = false;

            timerInterval = setInterval(() => {
                studySeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            if (!isTimerRunning) return;
            isTimerRunning = false;
            clearInterval(timerInterval);
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            
            // 1ë¶„ ì´ìƒ íƒ€ì´ë¨¸ê°€ ëŒì•˜ìœ¼ë©´ ê¸°ë¡ ì €ì¥
            if (studySeconds >= 60) {
                saveStudyBlock(studySeconds);
            }
        }

        function resetTimer() {
            pauseTimer();
            studySeconds = 0;
            updateTimerDisplay();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;
        }

        function updateTimerDisplay() {
            const h = Math.floor(studySeconds / 3600);
            const m = Math.floor((studySeconds % 3600) / 60);
            const s = studySeconds % 60;
            const timeStr = [h, m, s].map(v => String(v).padStart(2, '0')).join(':');
            document.getElementById('study-timer-display').textContent = timeStr;
        }

        async function saveStudyBlock(durationSeconds) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot save study block.");
            const dateStr = formatDate(new Date()); // í˜„ì¬ ë‚ ì§œ
            const durationMinutes = Math.ceil(durationSeconds / 60); // ë¶„ ë‹¨ìœ„ë¡œ ì €ì¥
            const now = new Date();
            const endTime = now.getHours() * 60 + now.getMinutes(); // ëë‚˜ëŠ” ì‹œê°„ (ë¶„ ë‹¨ìœ„)
            const startTime = endTime - durationMinutes;

            const newBlock = {
                startTime: startTime,
                duration: durationMinutes,
                note: 'ì§‘ì¤‘ í•™ìŠµ ì‹œê°„',
                // bookId ë“± ì¶”ê°€ ì •ë³´ëŠ” íƒ€ì´ë¨¸ì— ì—°ê²°í•˜ê¸° ë³µì¡í•˜ë¯€ë¡œ ë‹¨ìˆœ ì‹œê°„ ë¸”ë¡ë§Œ ì €ì¥
            };

            try {
                const docRef = getUserCollection('studyTimeline').doc(dateStr);
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    const blocks = doc.exists ? doc.data().blocks : [];

                    // ìƒˆ ë¸”ë¡ ì¶”ê°€
                    blocks.push(newBlock);
                    // ì‹œê°„ìˆœ ì •ë ¬
                    blocks.sort((a, b) => a.startTime - b.startTime);

                    transaction.set(docRef, { blocks: blocks }, { merge: true });
                });
                console.log("Study block saved successfully.");
                renderTimeline(dateStr); // UI ì—…ë°ì´íŠ¸
            } catch (e) {
                console.error("Error saving study block:", e);
            }
        }


        /*
         * ----------------------------------------------------
         * 4. ë‹¬ë ¥ ë° í•  ì¼ ê¸°ëŠ¥
         * ----------------------------------------------------
         */
        function renderCalendar(year, month) {
            const display = document.getElementById('month-year-display');
            display.textContent = `${year}ë…„ ${month + 1}ì›”`;

            const calendar = document.getElementById('calendar-view');
            calendar.innerHTML = '';

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
            const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

            // ì´ì „ ë‹¬ ë‚ ì§œ ì±„ìš°ê¸°
            for (let i = 0; i < firstDayOfMonth; i++) {
                const prevDay = lastDateOfPrevMonth - firstDayOfMonth + i + 1;
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.textContent = prevDay;
                calendar.appendChild(cell);
            }

            // í˜„ì¬ ë‹¬ ë‚ ì§œ ì±„ìš°ê¸°
            for (let date = 1; date <= lastDateOfMonth; date++) {
                const dateObj = new Date(year, month, date);
                const dateStr = formatDate(dateObj);
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.textContent = date;
                cell.dataset.date = dateStr;
                cell.onclick = () => selectDate(dateObj);

                // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
                if (dateStr === formatDate(new Date())) {
                    cell.classList.add('today');
                }
                // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
                if (dateStr === formatDate(selectedDate)) {
                    cell.classList.add('selected');
                }
                
                // í•  ì¼ ë§ˆì»¤ í‘œì‹œ
                const todos = dailyTodosData[dateStr] || [];
                if (todos.length > 0) {
                    const marker = document.createElement('div');
                    marker.className = 'todo-marker';
                    cell.appendChild(marker);
                }

                calendar.appendChild(cell);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentMonth + delta);
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth();
            renderCalendar(currentYear, currentMonth);
        }

        function selectDate(dateObj) {
            selectedDate = dateObj;
            renderCalendar(currentYear, currentMonth); // UI ì—…ë°ì´íŠ¸
            
            const dateStr = formatDate(selectedDate);
            document.getElementById('selected-date-display').textContent = dateStr === formatDate(new Date()) ? 'ì˜¤ëŠ˜' : dateStr;
            loadDailyTodosUI(dateStr);
            renderTimeline(dateStr);
        }

        function loadDailyTodosUI(dateStr) {
            const todos = dailyTodosData[dateStr] || [];
            const list = document.getElementById('todos-list');
            list.innerHTML = '';

            if (todos.length === 0) {
                list.innerHTML = `<p style="color:var(--secondary-text);">ì´ ë‚ ì§œì˜ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            todos.forEach((todo, index) => {
                const book = booksData.find(b => b.id === todo.bookId) || { title: 'ì•Œ ìˆ˜ ì—†ìŒ', id: todo.bookId };
                
                const item = document.createElement('div');
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.marginBottom = '10px';

                item.innerHTML = `
                    <input type="checkbox" id="todo-${dateStr}-${index}" ${todo.checked ? 'checked' : ''} onchange="toggleTodo('${dateStr}', ${index})" style="margin-right: 10px; transform: scale(1.2);">
                    <label for="todo-${dateStr}-${index}" style="flex-grow: 1; ${todo.checked ? 'text-decoration: line-through; color: var(--secondary-text);' : ''}">
                        [${book.title}] ${todo.startPage}p ~ ${todo.endPage}p (${(todo.endPage - todo.startPage) + 1}p)
                        <span style="font-size: 0.8em; display: block; color: ${todo.checked ? 'inherit' : '#555'};">${todo.note || ''}</span>
                    </label>
                    <button style="background:none; color:#ff5252; padding:5px; border-radius:50%; font-size:1.1em;" onclick="deleteTodo('${dateStr}', ${index})">&times;</button>
                `;
                list.appendChild(item);
            });
        }

        function renderTodoBookSelect(selectElement) {
            selectElement.innerHTML = booksData.map(book => 
                `<option value="${book.id}">${book.title}</option>`
            ).join('');
            if (booksData.length === 0) {
                selectElement.innerHTML = '<option value="">ë¬¸ì œì§‘ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”</option>';
                selectElement.disabled = true;
            } else {
                selectElement.disabled = false;
            }
        }

        // Firestore: ì¼ì¼ í•  ì¼ ì¶”ê°€
        async function addDailyTodo() {
            if (!isAuthReady) return console.error("Auth not ready. Cannot add todo.");
            const dateStr = formatDate(selectedDate);
            const bookId = document.getElementById('todo-book-select').value;
            const startPage = parseInt(document.getElementById('todo-start-page').value);
            const endPage = parseInt(document.getElementById('todo-end-page').value);
            const note = document.getElementById('todo-note').value;

            if (!bookId || isNaN(startPage) || isNaN(endPage) || startPage <= 0 || endPage < startPage) {
                alert('ë¬¸ì œì§‘ ì„ íƒê³¼ ìœ íš¨í•œ í˜ì´ì§€ ë²”ìœ„(ì‹œì‘ > 0, ë >= ì‹œì‘)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const newTodo = { bookId, startPage, endPage, note, checked: false };
            
            try {
                const docRef = getUserCollection('dailyTodos').doc(dateStr);
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    const todos = doc.exists ? doc.data().todos : [];
                    todos.push(newTodo);
                    transaction.set(docRef, { todos: todos }, { merge: true });
                });

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('todo-start-page').value = '';
                document.getElementById('todo-end-page').value = '';
                document.getElementById('todo-note').value = '';

                console.log(`Todo added for ${dateStr}.`);
                // UIëŠ” onSnapshotìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
            } catch (e) {
                console.error("Error adding daily todo:", e);
            }
        }

        // Firestore: í•  ì¼ ìƒíƒœ í† ê¸€
        async function toggleTodo(dateStr, index) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot toggle todo.");
            try {
                const docRef = getUserCollection('dailyTodos').doc(dateStr);
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (!doc.exists) return;
                    
                    const todos = doc.data().todos;
                    if (todos[index]) {
                        todos[index].checked = !todos[index].checked;
                        transaction.update(docRef, { todos: todos });
                    }
                });
                console.log(`Todo ${index} toggled for ${dateStr}.`);
            } catch (e) {
                console.error("Error toggling todo:", e);
            }
        }

        // Firestore: í•  ì¼ ì‚­ì œ
        async function deleteTodo(dateStr, index) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot delete todo.");
            try {
                const docRef = getUserCollection('dailyTodos').doc(dateStr);
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (!doc.exists) return;
                    
                    const todos = doc.data().todos;
                    if (todos[index]) {
                        todos.splice(index, 1); // ë°°ì—´ì—ì„œ ì‚­ì œ
                        transaction.set(docRef, { todos: todos }, { merge: true }); // ì—…ë°ì´íŠ¸
                    }
                });
                console.log(`Todo ${index} deleted for ${dateStr}.`);
            } catch (e) {
                console.error("Error deleting todo:", e);
            }
        }

        /*
         * ----------------------------------------------------
         * 5. íƒ€ì„ë¼ì¸ ê¸°ëŠ¥
         * ----------------------------------------------------
         */
        function renderTimeline(dateStr) {
            const chart = document.getElementById('timeline-chart');
            const blocks = studyTimelineData[dateStr] || [];
            
            // ê¸°ì¡´ ë¸”ë¡ ì œê±° (ì‹œê°„ í‘œì‹œ ìš”ì†Œ ì œì™¸)
            Array.from(chart.children).forEach(child => {
                if (child.classList.contains('timeline-block')) {
                    child.remove();
                }
            });

            // ìƒˆ ë¸”ë¡ ë Œë”ë§
            blocks.forEach(block => {
                const { startTime, duration, note } = block; // startTime: 0ì‹œë¶€í„° ë¶„ ë‹¨ìœ„
                
                const totalMinutes = 24 * 60;
                const topPercent = (startTime / totalMinutes) * 100;
                const heightPercent = (duration / totalMinutes) * 100;

                const blockDiv = document.createElement('div');
                blockDiv.className = 'timeline-block';
                blockDiv.style.top = `${topPercent}%`;
                blockDiv.style.height = `${heightPercent}%`;
                blockDiv.textContent = `${note || 'í•™ìŠµ ì‹œê°„'} (${duration}ë¶„)`;
                
                chart.appendChild(blockDiv);
            });
        }

        /*
         * ----------------------------------------------------
         * 6. ëª©í‘œ ë° ë¬¸ì œì§‘ ê¸°ëŠ¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         * ----------------------------------------------------
         */

        // ëª©í‘œ ì§„ì²™ë„ ê³„ì‚°
        function calculateGoalProgress(goalItem) {
            const book = booksData.find(b => b.id === goalItem.bookId);
            if (!book) return { completed: 0, total: 0, percent: 0 };
            
            // ëª©í‘œ ê¸°ê°„ ë‚´ ì™„ë£Œëœ í˜ì´ì§€ í•©ì‚°
            let completedPages = 0;
            const totalTargetPages = parseInt(goalItem.targetPages) || 0;
            
            if (totalTargetPages === 0) return { completed: 0, total: 0, percent: 0 };

            // ëª©í‘œ ê¸°ê°„ ì„¤ì • (ì›”ê°„ ëª©í‘œëŠ” í˜„ì¬ ì›”/ì£¼ê°„ ëª©í‘œëŠ” ì „ì²´ ê¸°ê°„)
            const startDate = goalItem.startDate ? parseDate(goalItem.startDate) : new Date(0);
            const endDate = goalItem.endDate ? parseDate(goalItem.endDate) : new Date(8640000000000000);
            
            for (const dateStr in dailyTodosData) {
                const date = parseDate(dateStr);
                // ëª©í‘œ ê¸°ê°„ ë‚´ì˜ ë°ì´í„°ë§Œ í™•ì¸
                if (date >= startDate && date <= endDate) {
                    const todosOnDate = dailyTodosData[dateStr] || [];
                    todosOnDate.forEach(todo => {
                        if (todo.checked && todo.bookId === book.id && todo.startPage && todo.endPage) {
                            completedPages += (todo.endPage - todo.startPage) + 1;
                        }
                    });
                }
            }
            
            const percent = totalTargetPages > 0 ?  
                Math.min(100, Math.round((completedPages / totalTargetPages) * 100)) : 0;
            
            return {
                completed: completedPages,
                total: totalTargetPages,
                percent: percent
            };
        }

        // ë¬¸ì œì§‘ ì§„ì²™ë„ ìë™ ê³„ì‚° (ì „ì²´ ê¸°ê°„)
        function calculateBookProgress(bookItem) {
            let completedPages = 0;
            const totalTargetPages = bookItem.targetPages || bookItem.pages || 0;

            if (totalTargetPages === 0) {
                return { completed: 0, total: 0, percent: 0 };
            }

            for (const dateStr in dailyTodosData) {
                const todosOnDate = dailyTodosData[dateStr] || [];
                todosOnDate.forEach(todo => {
                    if (todo.checked && todo.bookId === bookItem.id && todo.startPage && todo.endPage) {
                        completedPages += (todo.endPage - todo.startPage) + 1;
                    }
                });
            }

            const percent = totalTargetPages > 0 ?
                Math.min(100, Math.round((completedPages / totalTargetPages) * 100)) : 0;

            return {
                completed: completedPages,
                total: totalTargetPages,
                percent: percent
            };
        }

        function updateProgressAll() {
            loadGoalsUI('monthly');
            loadGoalsUI('weekly');
            renderBookShelf();
        }

        // ëª©í‘œ UI ë Œë”ë§
        function loadGoalsUI(key) {
            const tableBody = document.querySelector(`#${key}-goal-table tbody`);
            tableBody.innerHTML = '';
            const data = key === 'monthly' ? monthlyGoalsData : weeklyGoalsData;

            data.forEach(item => {
                const progress = calculateGoalProgress(item);
                const bookOptions = renderBookOptions(item.bookId);

                const row = tableBody.insertRow();
                row.innerHTML = `
                <td>
                    <input type="text" value="${item.goal || ''}" onchange="updateGoal('${key}', '${item.id}', 'goal', this.value)">
                    <div style="font-size:0.8em; color:var(--secondary-text); margin-top: 5px;">
                        <select onchange="updateGoal('${key}', '${item.id}', 'bookId', this.value)">
                            <option value="">- ë¬¸ì œì§‘ ì„ íƒ -</option>
                            ${bookOptions}
                        </select>
                        <input type="number" value="${item.targetPages || 0}" placeholder="ëª©í‘œ í˜ì´ì§€ ìˆ˜" onchange="updateGoal('${key}', '${item.id}', 'targetPages', parseInt(this.value) || 0)" style="width: 80px; margin-left: 5px;">
                    </div>
                </td>
                <td>
                    <input type="date" value="${item.startDate || ''}" onchange="updateGoal('${key}', '${item.id}', 'startDate', this.value)"> ~ 
                    <input type="date" value="${item.endDate || ''}" onchange="updateGoal('${key}', '${item.id}', 'endDate', this.value)">
                </td>
                <td>
                    <div class="progress-bar-container" style="height: 10px;">
                        <div class="progress-bar" style="width: ${progress.percent}%;"></div>
                    </div>
                    <span style="font-size: 0.8em; margin-top: 5px; display: block;">
                        ${progress.percent}% (${progress.completed}/${progress.total}p)
                    </span>
                </td>
                <td><input type="text" value="${item.note || ''}" onchange="updateGoal('${key}', '${item.id}', 'note', this.value)"></td>
                <td><button class="delete-btn" onclick="deleteRow('${key}', '${item.id}')">&times;</button></td>
                `;
            });
        }

        function renderBookOptions(selectedBookId) {
            let options = '';
            booksData.forEach(book => {
                options += `<option value="${book.id}" ${book.id === selectedBookId ? 'selected' : ''}>${book.title}</option>`;
            });
            return options;
        }

        // Firestore: ëª©í‘œ ì¶”ê°€
        async function addRow(key) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot add goal.");
            const collectionName = getGoalCollectionName(key);

            const newItem = {
                startDate: key === 'monthly' ? formatDate(new Date(currentYear, currentMonth, 1)) : '',
                endDate: key === 'monthly' ? formatDate(new Date(currentYear, currentMonth + 1, 0)) : '',
                goal: `ìƒˆ ${key} ëª©í‘œ`,
                bookId: '',
                targetPages: 0,
                note: ''
            };

            try {
                await db.collection('users').doc(userId).collection(collectionName).add(newItem);
                console.log(`${key} goal added.`);
            } catch (e) {
                console.error(`Error adding ${key} goal:`, e);
            }
        }

        // Firestore: ëª©í‘œ ìˆ˜ì •
        async function updateGoal(key, docId, field, value) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot update goal.");
            const collectionName = getGoalCollectionName(key);

            try {
                const goalRef = db.collection('users').doc(userId).collection(collectionName).doc(docId);
                await goalRef.update({ [field]: value });
                console.log(`Goal ${docId} updated: ${field} = ${value}`);
            } catch (e) {
                console.error(`Error updating ${key} goal:`, e);
            }
        }

        // Firestore: ëª©í‘œ ì‚­ì œ
        async function deleteRow(key, docId) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot delete goal.");
            if (!confirm("ì •ë§ë¡œ ì´ ëª©í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const collectionName = getGoalCollectionName(key);

            try {
                await db.collection('users').doc(userId).collection(collectionName).doc(docId).delete();
                console.log(`Goal ${docId} deleted.`);
            } catch (e) {
                console.error(`Error deleting ${key} goal:`, e);
            }
        }

        // ë¬¸ì œì§‘ UI ë Œë”ë§
        function renderBookShelf() {
            const grid = document.getElementById('book-shelf-grid');
            grid.innerHTML = '';
            
            if (booksData.length === 0) {
                grid.innerHTML = '<p style="color:var(--secondary-text); grid-column: 1 / -1;">ë“±ë¡ëœ ë¬¸ì œì§‘ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            booksData.forEach(book => {
                const progress = calculateBookProgress(book);
                const card = document.createElement('div');
                card.className = 'book-card';
                card.style.cursor = 'pointer';
                card.onclick = () => openBookModal(book);

                const defaultImage = `https://placehold.co/100x150/bbdefb/444?text=${encodeURIComponent(book.title.substring(0, 10))}`;
                const imageUrl = book.image || defaultImage;

                card.innerHTML = `
                <div style="background-color: var(--card-background); padding: 15px;">
                    <div class="book-info" style="display: flex; align-items: flex-start; gap: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
                        <img src="${imageUrl}" alt="${book.title} í‘œì§€" onerror="this.onerror=null; this.src='${defaultImage}'" style="width: 80px; height: 120px; object-fit: cover; border-radius: 4px; box-shadow: var(--shadow-light);">
                        <div style="flex-grow: 1;">
                            <h4 style="margin: 0; font-weight: 700; color: var(--accent-main);">${book.title}</h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.85em; color: var(--secondary-text);">ì´ ${book.pages || '?'}p | ëª©í‘œ ${book.targetPages || 0}p</p>
                        </div>
                    </div>

                    <div class="book-progress-text" style="font-size: 0.9em; font-weight: 600; margin-top: 5px;">ìˆ˜í–‰ë¥ : ${progress.percent}%</div>
                    <div class="progress-bar-container" style="height: 8px; background: #eee; border-radius: 5px; overflow: hidden; width: 100%;">
                        <div class="progress-bar" style="width: ${progress.percent}%;"></div>
                    </div>
                    <p style="font-size: 0.8em; color: var(--secondary-text); margin-top: 5px;">${progress.completed} / ${progress.total} í˜ì´ì§€ ì™„ë£Œ</p>
                    <button onclick="event.stopPropagation(); deleteBook('${book.id}')" style="background: #ff5252; padding: 5px 10px; margin-top: 10px; font-size: 0.8em;">ì‚­ì œ</button>
                </div>
                `;
                grid.appendChild(card);
            });
        }

        function openBookModal(book = null) {
            const modal = document.getElementById('book-modal');

            document.getElementById('book-edit-id').value = book ? book.id : '';
            document.getElementById('book-title').value = book ? book.title : '';
            document.getElementById('book-image').value = book ? book.image : '';
            document.getElementById('book-pages').value = book ? book.pages : '';
            document.getElementById('book-target-pages').value = book ? book.targetPages : '';
            document.getElementById('book-index').value = book ? book.index : '';

            modal.style.display = 'block';
        }

        function closeBookModal() {
            document.getElementById('book-modal').style.display = 'none';
        }

        // Firestore: ë¬¸ì œì§‘ ì €ì¥/ìˆ˜ì •
        async function saveBook() {
            if (!isAuthReady) return console.error("Auth not ready. Cannot save book.");
            const bookId = document.getElementById('book-edit-id').value;
            const title = document.getElementById('book-title').value;
            const pages = parseInt(document.getElementById('book-pages').value) || 0;
            const targetPages = parseInt(document.getElementById('book-target-pages').value) || pages;
            const image = document.getElementById('book-image').value;
            const index = document.getElementById('book-index').value;

            if (!title) { alert('ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            if (pages <= 0) { alert('ì´ í˜ì´ì§€ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            const bookData = { title, pages, targetPages, image, index };

            try {
                if (bookId) {
                    // ìˆ˜ì •
                    await db.collection('users').doc(userId).collection('books').doc(bookId).update(bookData);
                    console.log(`Book ${bookId} updated.`);
                } else {
                    // ë“±ë¡
                    await db.collection('users').doc(userId).collection('books').add(bookData);
                    console.log('New book added.');
                }
                closeBookModal();
            } catch (e) {
                console.error("Error saving book:", e);
            }
        }

        // Firestore: ë¬¸ì œì§‘ ì‚­ì œ
        async function deleteBook(docId) {
            if (!isAuthReady) return console.error("Auth not ready. Cannot delete book.");
            if (!confirm("ì •ë§ë¡œ ì´ ë¬¸ì œì§‘ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ëª©í‘œ ë° í•  ì¼ ë°ì´í„°ëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.")) return;
            try {
                await db.collection('users').doc(userId).collection('books').doc(docId).delete();
                console.log(`Book ${docId} deleted.`);
                // onSnapshotì— ì˜í•´ UI ìë™ ì—…ë°ì´íŠ¸
            } catch (e) {
                console.error("Error deleting book:", e);
            }
        }

        // ì´ˆê¸° ì‹¤í–‰
        updateTimerDisplay(); // íƒ€ì´ë¨¸ ë””ìŠ¤í”Œë ˆì´ ì´ˆê¸°í™”
        renderCalendar(currentYear, currentMonth); // ë‹¬ë ¥ ì´ˆê¸° ë Œë”ë§
        selectDate(new Date()); // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ì„ íƒëœ ë‚ ì§œë¡œ ì„¤ì •
    </script>
</body>
</html>
